!function(t,e){"function"==typeof define&&define.amd?define(e):"object"==typeof exports?module.exports=e():t.Asteroid=e()}(this,function(){"use strict";function t(t){return null===t?null:JSON.parse(JSON.stringify(t))}function e(){for(var t="",e=0;8>e;e++)t+=Math.floor(65536*(1+Math.random())).toString(16).substring(1);return t}function o(t,e){var o=JSON.stringify(t),i=JSON.stringify(e);return o===i}var i=function(t){this._host=t.host,this._ddpOptions=t.ddpOptions,this._ddpOptions.do_not_autoconnect=!0,this._do_not_autocreate_collections=t._do_not_autocreate_collections,this.collections={},this._init()};i.prototype.constructor=i,i.prototype._init=function(){var t=this;t.ddp=new DDP(this._ddpOptions),t.ddp.on("connected",function(){t._do_not_autocreate_collections||(t._tryResumeLogin(),t.ddp.sub("meteor.loginServiceConfiguration"))}),t.ddp.on("added",t._onAdded.bind(t)),t.ddp.on("changed",t._onChanged.bind(t)),t.ddp.on("removed",t._onRemoved.bind(t)),t.ddp.connect()},i.prototype._onAdded=function(t){var e=t.collection;if(!this.collections[e]){if(this._do_not_autocreate_collections)return;this.collections[e]=new i.Collection(e,this,i.DumbDb)}var o=t.fields;o._id=t.id,this.collections[e]._localInsert(o,!0)},i.prototype._onRemoved=function(t){this.collections[t.collection]&&this.collections[t.collection]._localRemove(t.id)},i.prototype._onChanged=function(t){this.collections[t.collection]&&(t.cleared.forEach(function(e){t.fields[e]=void 0}),this.collections[t.collection]._localUpdate(t.id,t.fields))},i.prototype.subscribe=function(t){var e=Q.defer(),o=Array.prototype.slice.call(arguments,1);return this.ddp.sub(t,o,function(t,e){t?promise.reject(t,e):promise.resolve(e)}),e.promise},i.prototype.unsubscribe=function(t){this.ddp.unsub(t)},i.prototype.call=function(t){var e=Array.prototype.slice.call(arguments,1);return this.apply(t,e)},i.prototype.apply=function(t,e){var o=Q.defer(),i=Q.defer(),n=function(t,e){t?(o.reject(t),i.reject()):o.resolve(e)},r=function(){i.resolve()};return this.ddp.method(t,e,n,r),[o.promise,i.promise]};var n=function(t,e,o){this.name=t,this.asteroid=e,this.db=new o,this._events={}};n.prototype.constructor=n,n.prototype._localInsert=function(t,e){var i=this.db.get(t._id);if(!e||!o(i,t)){if(!e&&i)throw new Error("Item exists.");this.db.set(t._id,t),this._emit("change")}},n.prototype._remoteInsert=function(t){var e=this,o="/"+e.name+"/insert";this.asteroid.ddp.method(o,[t],function(o){if(o)throw e._localRemove(t._id),o})},n.prototype.insert=function(t){t._id||(t._id=e()),this._localInsert(t,!1),this._remoteInsert(t)};var r="__del__";n.prototype._localRemove=function(t){var e=this.db.get(t);return e?(this.db.del(t),this.db.del(t+r),void this._emit("change")):void console.warn("Item not present.")},n.prototype._localRestoreRemoved=function(t){var e=this.db.get(t+r);this.db.set(t,e),this.db.del(t+r),this._emit("change")},n.prototype._localMarkForRemoval=function(t){var e=this.db.get(t);return e?(this.db.set(t+r,e),this.db.del(t),void this._emit("change")):void console.warn("Item not present.")},n.prototype._remoteRemove=function(t){var e=this,o="/"+e.name+"/remove";this.asteroid.ddp.method(o,[{_id:t}],function(o){if(o)throw e._localRestoreRemoved(t),o})},n.prototype.remove=function(t){this._localMarkForRemoval(t),this._remoteRemove(t)};var s="__upd__";n.prototype._localUpdate=function(t,e){var o=this.db.get(t);if(!o)return void console.warn("Item not present.");for(var i in e)existsing[i]=e[i];this.db.set(t,o),this.db.del(t+s),this._emit("change")},n.prototype._localRestoreUpdated=function(t){var e=this.db.get(t+s);this.db.set(t,e),this.db.del(t+s),this._emit("change")},n.prototype._localMarkForUpdate=function(t,e){var o=this.db.get(t);return o?(this.db.set(t+s,o),this.db.set(t,e),void this._emit("change")):void console.warn("Item not present.")},n.prototype._remoteUpdate=function(t,e){var o=this,i="/"+o.name+"/update";this.asteroid.ddp.method(i,[{_id:t},{$set:e}],function(e){if(e)throw o._localRestoreUpdated(t),e})},n.prototype.update=function(t){this._localMarkForUpdate(t),this._remoteUpdate(t)},n.prototype.on=function(t,e){this._events[t]=this._events[t]||[],this._events[t].push(e)},n.prototype.off=function(t,e){this._events[t]&&this._events[t].splice(this._events[t].indexOf(e),1)},n.prototype._emit=function(t){if(this._events[t]){var e=arguments,o=this;this._events[t].forEach(function(t){t.apply(o,Array.prototype.slice.call(e,1))})}},i.Collection=n;var c=function(){this.itemsHash={},this.itemsArray=[]};return c.prototype.set=function(t,e){this.itemsHash[t]=e,this.itemsArray.push(e)},c.prototype.get=function(e){return this.itemsHash[e]?t(this.itemsHash[e]):void 0},c.prototype.del=function(t){if(this.itemsHash[t]){var e=this.itemsArray.indexOf(this.itemsHash[t]);this.itemsArray.splice(e,1),delete this.itemsHash[t]}},c.prototype.ls=function(){return t(this.itemsArray)},i.DumbDb=c,i.prototype._getOauthClientId=function(t){var e="meteor_accounts_loginServiceConfiguration",o=this.collections[e].db.itemsArray,i="";return o.forEach(function(e){e.service===t&&("facebook"===t&&(i=e.appId),"google"===t&&(i=e.clientId),"github"===t&&(i=e.clientId),"twitter"===t&&(i=e.consumerKey))}),i},i.prototype._initOauthLogin=function(t,e,o){var i=this;return Q().then(function(){var t=Q.defer(),e=window.open(o,"Login");e.focus&&e.focus();var i=setInterval(function(){(e.closed||void 0===e.closed)&&(clearInterval(i),t.resolve())},100);return t.promise}).then(function(){var t=Q.defer(),o={oauth:{credentialToken:e}};return i.ddp.method("login",[o],function(e,o){return e?t.reject():(i.userId=o.id,localStorage[i._host+"__login_token__"]=o.token,void t.resolve(o.id))}),t.promise})},i.prototype._tryResumeLogin=function(){var t=this,e=localStorage[t._host+"__login_token__"];return e?Q().then(function(){var o=Q.defer(),i={resume:e};return t.ddp.method("login",[i],function(e,i){return e?o.reject():(t.userId=i.id,localStorage[t._host+"__login_token__"]=i.token,void o.resolve(i.id))}),o.promise}).fail(function(){t.userId=null,delete localStorage[t._host+"__login_token__"]}):void 0},i.prototype.loginWithFacebook=function(t){var o=e(),i={client_id:this._getOauthClientId("facebook"),redirect_uri:this._host+"/_oauth/facebook?close",state:o,scope:t||"email"},n="https://www.facebook.com/dialog/oauth?"+formQs(i);return this._initOauthLogin("facebook",o,n)},i.prototype.loginWithGoogle=function(t){var o=e(),i={response_type:"code",client_id:this._getOauthClientId("google"),redirect_uri:this._host+"/_oauth/google?close",state:o,scope:t||"openid email"},n="https://accounts.google.com/o/oauth2/auth?"+formQs(i);return this._initOauthLogin("google",o,n)},i.prototype.loginWithGithub=function(t){var o=e(),i={client_id:this._getOauthClientId("github"),redirect_uri:this._host+"/_oauth/github?close",state:o,scope:t||"email"},n="https://github.com/login/oauth/authorize?"+formQs(i);return this._initOauthLogin("github",o,n)},i.prototype.loginWithTwitter=function(){var t=e(),o=this._host+"/_oauth/twitter?close&state="+t,i={requestTokenAndRedirect:encodeURIComponent(o),state:t},n=this._host+"/_oauth/twitter/?"+formQs(i);return this._initOauthLogin("twitter",t,n)},i.prototype.logout=function(){},i});