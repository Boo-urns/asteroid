!function(t,e){"function"==typeof define&&define.amd?define(e):"object"==typeof exports?module.exports=e():t.Asteroid=e()}(this,function(){"use strict";function t(t){return null===t?null:JSON.parse(JSON.stringify(t))}function e(t){var e="";for(var o in t)e+=o+"="+t[o]+"&";return e=e.slice(0,-1)}function o(){for(var t="",e=0;8>e;e++)t+=Math.floor(65536*(1+Math.random())).toString(16).substring(1);return t}function i(t,e){var o=JSON.stringify(t),i=JSON.stringify(e);return o===i}var n=function(){};n.prototype={constructor:n,_events:{},on:function(t,e){this._events[t]=this._events[t]||[],this._events[t].push(e)},off:function(t,e){this._events[t]&&this._events[t].splice(this._events[t].indexOf(e),1)},_emit:function(t){if(this._events[t]){var e=arguments,o=this;this._events[t].forEach(function(t){t.apply(o,Array.prototype.slice.call(e,1))})}}};var r=function(t){this._host=t.host,this._ddpOptions=t.ddpOptions,this._ddpOptions.do_not_autoconnect=!0,this._do_not_autocreate_collections=t._do_not_autocreate_collections,this.collections={},this._init()};r.prototype=new n,r.prototype.constructor=r,r.prototype._init=function(){var t=this;t.ddp=new DDP(this._ddpOptions),t.ddp.on("connected",function(){t._tryResumeLogin(),t.ddp.sub("meteor.loginServiceConfiguration"),t._emit("connected")}),t.ddp.on("added",t._onAdded.bind(t)),t.ddp.on("changed",t._onChanged.bind(t)),t.ddp.on("removed",t._onRemoved.bind(t)),t.ddp.connect()},r.prototype._onAdded=function(t){var e="meteor_accounts_loginServiceConfiguration",o=t.collection;if(!this.collections[o]){if(this._do_not_autocreate_collections&&o!==e&&"users"!==o)return;new r.Collection(o,this,r.DumbDb)}var i=t.fields||{};i._id=t.id,this.collections[o]._localInsert(i,!0)},r.prototype._onRemoved=function(t){this.collections[t.collection]&&this.collections[t.collection]._localRemove(t.id)},r.prototype._onChanged=function(t){this.collections[t.collection]&&(t.cleared.forEach(function(e){t.fields[e]=void 0}),this.collections[t.collection]._localUpdate(t.id,t.fields))},r.prototype.subscribe=function(t){var e=Q.defer(),o=Array.prototype.slice.call(arguments,1);return this.ddp.sub(t,o,function(t,o){t?e.reject(t,o):e.resolve(o)}),e.promise},r.prototype.unsubscribe=function(t){this.ddp.unsub(t)},r.prototype.call=function(t){var e=Array.prototype.slice.call(arguments,1);return this.apply(t,e)},r.prototype.apply=function(t,e){var o=Q.defer(),i=Q.defer(),n=function(t,e){t?(o.reject(t),i.reject()):o.resolve(e)},r=function(){i.resolve()};return this.ddp.method(t,e,n,r),[o.promise,i.promise]};var s=function(t,e,o){this.name=t,this.asteroid=e,this.asteroid.collections[t]=this,this.db=new o};s.prototype=new n,s.prototype.constructor=s,s.prototype._localInsert=function(t,e){var o=this.db.get(t._id);if(!e||!i(o,t)){if(!e&&o)throw new Error("Item exists.");this.db.set(t._id,t),this._emit("change")}},s.prototype._remoteInsert=function(t){var e=this,o="/"+e.name+"/insert";this.asteroid.ddp.method(o,[t],function(o){if(o)throw e._localRemove(t._id),o})},s.prototype.insert=function(t){t._id||(t._id=o()),this._localInsert(t,!1),this._remoteInsert(t)};var c="__del__";s.prototype._localRemove=function(t){var e=this.db.get(t);return e?(this.db.del(t),this.db.del(t+c),void this._emit("change")):void console.warn("Item not present.")},s.prototype._localRestoreRemoved=function(t){var e=this.db.get(t+c);this.db.set(t,e),this.db.del(t+c),this._emit("change")},s.prototype._localMarkForRemoval=function(t){var e=this.db.get(t);return e?(this.db.set(t+c,e),this.db.del(t),void this._emit("change")):void console.warn("Item not present.")},s.prototype._remoteRemove=function(t){var e=this,o="/"+e.name+"/remove";this.asteroid.ddp.method(o,[{_id:t}],function(o){if(o)throw e._localRestoreRemoved(t),o})},s.prototype.remove=function(t){this._localMarkForRemoval(t),this._remoteRemove(t)};var a="__upd__";s.prototype._localUpdate=function(t,e){var o=this.db.get(t);if(!o)return void console.warn("Item not present.");for(var i in e)existsing[i]=e[i];this.db.set(t,o),this.db.del(t+a),this._emit("change")},s.prototype._localRestoreUpdated=function(t){var e=this.db.get(t+a);this.db.set(t,e),this.db.del(t+a),this._emit("change")},s.prototype._localMarkForUpdate=function(t,e){var o=this.db.get(t);return o?(this.db.set(t+a,o),this.db.set(t,e),void this._emit("change")):void console.warn("Item not present.")},s.prototype._remoteUpdate=function(t,e){var o=this,i="/"+o.name+"/update";this.asteroid.ddp.method(i,[{_id:t},{$set:e}],function(e){if(e)throw o._localRestoreUpdated(t),e})},s.prototype.update=function(t){this._localMarkForUpdate(t),this._remoteUpdate(t)},r.Collection=s;var d=function(){this.itemsHash={},this.itemsArray=[]};return d.prototype.set=function(t,e){this.itemsHash[t]=e,this.itemsArray.push(e)},d.prototype.get=function(e){return this.itemsHash[e]?t(this.itemsHash[e]):void 0},d.prototype.del=function(t){if(this.itemsHash[t]){var e=this.itemsArray.indexOf(this.itemsHash[t]);this.itemsArray.splice(e,1),delete this.itemsHash[t]}},d.prototype.ls=function(){return t(this.itemsArray)},r.DumbDb=d,r.prototype._getOauthClientId=function(t){var e="meteor_accounts_loginServiceConfiguration",o=this.collections[e].db.itemsArray,i="";return o.forEach(function(e){e.service===t&&("facebook"===t&&(i=e.appId),"google"===t&&(i=e.clientId),"github"===t&&(i=e.clientId),"twitter"===t&&(i=e.consumerKey))}),i},r.prototype._initOauthLogin=function(t,e,o){var i=this;return Q().then(function(){var t=Q.defer(),e=window.open(o,"Login");e.focus&&e.focus();var i=setInterval(function(){(e.closed||void 0===e.closed)&&(clearInterval(i),t.resolve())},100);return t.promise}).then(function(){var t=Q.defer(),o={oauth:{credentialToken:e}};return i.ddp.method("login",[o],function(e,o){return e?t.reject():(i.userId=o.id,localStorage[i._host+"__login_token__"]=o.token,i._emit("login",o),void t.resolve(o.id))}),t.promise})},r.prototype._tryResumeLogin=function(){var t=this,e=localStorage[t._host+"__login_token__"];return e?Q().then(function(){var o=Q.defer(),i={resume:e};return t.ddp.method("login",[i],function(e,i){return e?o.reject():(t.userId=i.id,localStorage[t._host+"__login_token__"]=i.token,t._emit("login",i),void o.resolve(i.id))}),o.promise}).fail(function(){t.userId=null,delete localStorage[t._host+"__login_token__"],t._emit("logout")}):void 0},r.prototype.loginWithFacebook=function(t){var i=o(),n={client_id:this._getOauthClientId("facebook"),redirect_uri:this._host+"/_oauth/facebook?close",state:i,scope:t||"email"},r="https://www.facebook.com/dialog/oauth?"+e(n);return this._initOauthLogin("facebook",i,r)},r.prototype.loginWithGoogle=function(t){var i=o(),n={response_type:"code",client_id:this._getOauthClientId("google"),redirect_uri:this._host+"/_oauth/google?close",state:i,scope:t||"openid email"},r="https://accounts.google.com/o/oauth2/auth?"+e(n);return this._initOauthLogin("google",i,r)},r.prototype.loginWithGithub=function(t){var i=o(),n={client_id:this._getOauthClientId("github"),redirect_uri:this._host+"/_oauth/github?close",state:i,scope:t||"email"},r="https://github.com/login/oauth/authorize?"+e(n);return this._initOauthLogin("github",i,r)},r.prototype.loginWithTwitter=function(){var t=o(),i=this._host+"/_oauth/twitter?close&state="+t,n={requestTokenAndRedirect:encodeURIComponent(i),state:t},r=this._host+"/_oauth/twitter/?"+e(n);return this._initOauthLogin("twitter",t,r)},r.prototype.logout=function(){},r});