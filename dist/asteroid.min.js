!function(t,e){"function"==typeof define&&define.amd?define(e):"object"==typeof exports?module.exports=e():t.Asteroid=e()}(this,function(){"use strict";function t(t){if("undefined"!=typeof EJSON)return EJSON.clone(t);var e=typeof t;switch(e){case"undefined":case"function":return void 0;case"string":case"number":case"boolean":return t;case"object":return null===t?null:JSON.parse(JSON.stringify(t));default:return}}function e(t){var e="";for(var o in t)e+=o+"="+t[o]+"&";return e=e.slice(0,-1)}function o(){for(var t="",e=0;8>e;e++)t+=Math.floor(65536*(1+Math.random())).toString(16).substring(1);return t}function i(t){return-1!==t.indexOf("@")}var n=function(){};n.prototype={constructor:n,on:function(t,e){this._events||(this._events={}),this._events[t]=this._events[t]||[],this._events[t].push(e)},off:function(t,e){this._events||(this._events={}),this._events[t]&&this._events[t].splice(this._events[t].indexOf(e),1)},_emit:function(t){if(this._events||(this._events={}),this._events[t]){var e=arguments,o=this;this._events[t].forEach(function(t){t.apply(o,Array.prototype.slice.call(e,1))})}}};var r=function(t){var e=function(t,e){return e.split(".").reduce(function(t,e){return t?t=t[e]:t},t)},o=Object.keys(t),i=o.map(function(o){var i;return"$and"===o?(i=t[o].map(r),function(t){return i.reduce(function(e,o){return e?o(t):e},!0)}):"$or"===o?(i=t[o].map(r),function(t){return i.reduce(function(e,o){return e?e:o(t)},!1)}):"$nor"===o?(i=t[o].map(r),function(t){return i.reduce(function(e,o){return e?!o(t):e},!0)}):function(i){var n=e(i,o);return n===t[o]}});return function(t){return t._id&&_(t._id)?!1:i.reduce(function(e,o){return e?o(t):e},!0)}},s=!(!window.chrome||!window.chrome.extension),c={get:function(t){var e=Q.defer();return s?chrome.storage.local.get(t,function(o){e.resolve(o[t])}):e.resolve(localStorage[t]),e.promise},set:function(t,e){var o=Q.defer();if(s){var i={};i[t]=e,chrome.storage.local.set(i,function(){o.resolve()})}else localStorage[t]=e,o.resolve();return o.promise},del:function(t){var e=Q.defer();return s?chrome.storage.local.remove(t,function(){e.resolve()}):(delete localStorage[t],e.resolve()),e.promise}},u={};u._toString=function(t){return Object.prototype.toString.call(t).slice(8,-1)},u.beString=function(t){var e=this._toString(t);if("String"!==e)throw new Error("Assertion failed: expected String, instead got "+e)},u.beArray=function(t){var e=this._toString(t);if("Array"!==e)throw new Error("Assertion failed: expected Array, instead got "+e)},u.beObject=function(t){var e=this._toString(t);if("Object"!==e)throw new Error("Assertion failed: expected Object, instead got "+e)};var a=function(t,e,o,i){u.beString(t),this._instanceId=i||"0",this._host=(e?"https://":"http://")+t,this._ddpOptions="function"==typeof SockJS?{endpoint:(e?"https://":"http://")+t+"/sockjs",SocketConstructor:SockJS,socketInterceptFunction:o}:{endpoint:(e?"wss://":"ws://")+t+"/websocket",SocketConstructor:WebSocket,socketInterceptFunction:o},this.collections={},this.subscriptions={},this._subscriptionsCache={},this._init()};a.prototype=Object.create(n.prototype),a.prototype.constructor=a,a.prototype._init=function(){var t=this;t.ddp=new DDP(this._ddpOptions),t.ddp.on("connected",function(){t.resumeLoginPromise=t._tryResumeLogin(),t.subscribe("meteor.loginServiceConfiguration"),t._emit("connected")}),t.ddp.on("reconnected",function(){t.resumeLoginPromise=t._tryResumeLogin(),t._reEstablishSubscriptions(),t._emit("reconnected")}),t.ddp.on("added",function(e){t._onAdded(e)}),t.ddp.on("changed",function(e){t._onChanged(e)}),t.ddp.on("removed",function(e){t._onRemoved(e)})},a.prototype._onAdded=function(t){var e=t.collection;this.collections[e]||(this.collections[e]=new a._Collection(e,this));var o=t.fields||{};o._id=t.id,this.collections[e]._remoteToLocalInsert(o)},a.prototype._onRemoved=function(t){this.collections[t.collection]&&this.collections[t.collection]._remoteToLocalRemove(t.id)},a.prototype._onChanged=function(t){this.collections[t.collection]&&(t.fields||(t.fields={}),t.cleared&&t.cleared.forEach(function(e){t.fields[e]=void 0}),this.collections[t.collection]._remoteToLocalUpdate(t.id,t.fields))},a.prototype.call=function(t){u.beString(t);var e=Array.prototype.slice.call(arguments,1);return this.apply(t,e)},a.prototype.apply=function(t,e){u.beString(t),Array.isArray(e)||(e=[]);var o=Q.defer(),i=Q.defer(),n=function(t,e){t?(o.reject(t),i.reject()):o.resolve(e)},r=function(){i.resolve()};return this.ddp.method(t,e,n,r),{result:o.promise,updated:i.promise}},a.prototype.getCollection=function(t){return u.beString(t),this.collections[t]||(this.collections[t]=new a._Collection(t,this)),this.collections[t]};var d="__del__",l="__upd__",_=function(t){var e=d.length,o=l.length,i=t.slice(-1*e),n=t.slice(-1*o);return i===d||n===l},h=function(t,e){this.name=t,this.asteroid=e,this._set=new f};h.prototype.constructor=h,h.prototype._localToLocalInsert=function(t){if(this._set.contains(t._id))throw new Error("Item "+t._id+" already exists");return this._set.put(t._id,t),Q(t._id)},h.prototype._remoteToLocalInsert=function(t){this._set.put(t._id,t)},h.prototype._localToRemoteInsert=function(t){var e=this,o=Q.defer(),i="/"+e.name+"/insert";return e.asteroid.ddp.method(i,[t],function(i){i?(e._set.del(t._id),o.reject(i)):o.resolve(t._id)}),o.promise},h.prototype.insert=function(t){return t._id||(t._id=o()),{local:this._localToLocalInsert(t),remote:this._localToRemoteInsert(t)}},h.prototype._localToLocalRemove=function(t){var e=this._set.get(t);return e&&(this._set.put(t+d,e),this._set.del(t)),Q(t)},h.prototype._remoteToLocalRemove=function(t){this._set.del(t)},h.prototype._localToRemoteRemove=function(t){var e=this,o=Q.defer(),i="/"+e.name+"/remove";return e.asteroid.ddp.method(i,[{_id:t}],function(i){if(i){var n=e._set.get(t+d);n&&(e._set.put(t,n),e._set.del(t+d)),o.reject(i)}else e._set.del(t+d),o.resolve(t)}),o.promise},h.prototype.remove=function(t){return{local:this._localToLocalRemove(t),remote:this._localToRemoteRemove(t)}},h.prototype._localToLocalUpdate=function(t,e){var o=this._set.get(t);if(!o)throw new Error("Item "+t+" doesn't exist");if(e._id&&e._id!==t)throw new Error("Modifying the _id of a document is not allowed");this._set.put(t+l,o);for(var i in e)o[i]=e[i];return this._set.put(t,o),Q(t)},h.prototype._remoteToLocalUpdate=function(t,e){var o=this._set.get(t);if(!o)return void console.warn("Server misbehaviour: item "+t+" doesn't exist");for(var i in e){if("_id"===i&&e._id!==t)return void console.warn("Server misbehaviour: modifying the _id of a document is not allowed");o[i]=e[i]}this._set.put(t,o)},h.prototype._localToRemoteUpdate=function(t,e){var o=this,i=Q.defer(),n="/"+o.name+"/update",r={_id:t},s={$set:e};return o.asteroid.ddp.method(n,[r,s],function(e){if(e){var n=o._set.get(t+l);o._set.put(t,n),o._set.del(t+l),i.reject(e)}else o._set.del(t+l),i.resolve(t)}),i.promise},h.prototype.update=function(t,e){return{local:this._localToLocalUpdate(t,e),remote:this._localToRemoteUpdate(t,e)}};var p=function(t){var e=this;e.result=[],e._set=t,e._getResult(),e._set.on("put",function(t){e._getResult(),e._emit("change",t)}),e._set.on("del",function(t){e._getResult(),e._emit("change",t)})};p.prototype=Object.create(n.prototype),p.constructor=p,p.prototype._getResult=function(){this.result=this._set.toArray()},h.prototype.reactiveQuery=function(t){var e;e="function"==typeof t?t:r(t);var o=this._set.filter(e);return new p(o)},a._Collection=h,a.prototype._getOauthClientId=function(t){var e="meteor_accounts_loginServiceConfiguration",o=this.collections[e],i=o.reactiveQuery({service:t}).result[0];return i.clientId||i.consumerKey||i.appId},a.prototype._initOauthLogin=function(t,e,o){var i=window.open(o,"_blank","location=no,toolbar=no");i.focus&&i.focus();var n=this;return Q().then(function(){var t=Q.defer();if(window.cordova)i.addEventListener("loadstop",function(o){if(-1!==o.url.indexOf("#")){var n=o.url.indexOf("#"),r=o.url.slice(n+1).split("&");if(r[0]&&"credentialToken"===r[0].split("=")[0]&&r[1]&&"credentialSecret"===r[1].split("=")[0]){var s=r[0].split("=")[1],c=r[1].split("=")[1];s===e&&(t.resolve(c),i.close())}}});else{var o=JSON.stringify({credentialToken:e}),r=setInterval(function(){i.postMessage(o,n._host)},100);window.addEventListener("message",function(o){var i;try{i=JSON.parse(o.data)}catch(s){return}o.origin===n._host&&(i.credentialToken===e&&(clearInterval(r),t.resolve(i.credentialSecret)),i.error&&(clearInterval(r),t.reject(i.error)))})}return t.promise}).then(function(t){var o=Q.defer(),i={oauth:{credentialToken:e,credentialSecret:t}};return n.ddp.method("login",[i],function(t,e){t?(delete n.userId,delete n.loggedIn,c.del(n._host+"__"+n._instanceId+"__login_token__"),o.reject(t),n._emit("loginError",t)):(n.userId=e.id,n.loggedIn=!0,c.set(n._host+"__"+n._instanceId+"__login_token__",e.token),n._emit("login",e.id),o.resolve(e.id))}),o.promise})},a.prototype.loginWithFacebook=function(t){var i=o(),n={client_id:this._getOauthClientId("facebook"),redirect_uri:this._host+"/_oauth/facebook?close",state:i,scope:t||"email"},r="https://www.facebook.com/dialog/oauth?"+e(n);return this._initOauthLogin("facebook",i,r)},a.prototype.loginWithGoogle=function(t){var i=o(),n={response_type:"code",client_id:this._getOauthClientId("google"),redirect_uri:this._host+"/_oauth/google?close",state:i,scope:t||"openid email"},r="https://accounts.google.com/o/oauth2/auth?"+e(n);return this._initOauthLogin("google",i,r)},a.prototype.loginWithGithub=function(t){var i=o(),n={client_id:this._getOauthClientId("github"),redirect_uri:this._host+"/_oauth/github?close",state:i,scope:t||"email"},r="https://github.com/login/oauth/authorize?"+e(n);return this._initOauthLogin("github",i,r)},a.prototype.loginWithTwitter=function(){var t=o(),i=this._host+"/_oauth/twitter?close&state="+t,n={requestTokenAndRedirect:encodeURIComponent(i),state:t},r=this._host+"/_oauth/twitter/?"+e(n);return this._initOauthLogin("twitter",t,r)},a.prototype._tryResumeLogin=function(){var t=this;return Q().then(function(){return c.get(t._host+"__"+t._instanceId+"__login_token__")}).then(function(t){if(!t)throw new Error("No login token");return t}).then(function(e){var o=Q.defer(),i={resume:e};return t.ddp.method("login",[i],function(e,i){e?(delete t.userId,delete t.loggedIn,c.del(t._host+"__"+t._instanceId+"__login_token__"),t._emit("loginError",e),o.reject(e)):(t.userId=i.id,t.loggedIn=!0,c.set(t._host+"__"+t._instanceId+"__login_token__",i.token),t._emit("login",i.id),o.resolve(i.id))}),o.promise})},a.prototype.createUser=function(t,e,o){var n=this,r=Q.defer(),s={username:i(t)?void 0:t,email:i(t)?t:void 0,password:e,profile:o};return n.ddp.method("createUser",[s],function(t,e){t?(n._emit("createUserError",t),r.reject(t)):(n.userId=e.id,n.loggedIn=!0,c.set(n._host+"__"+n._instanceId+"__login_token__",e.token),n._emit("createUser",e.id),n._emit("login",e.id),r.resolve(e.id))}),r.promise},a.prototype.loginWithPassword=function(t,e){var o=this,n=Q.defer(),r={password:e,user:{username:i(t)?void 0:t,email:i(t)?t:void 0}};return o.ddp.method("login",[r],function(t,e){t?(delete o.userId,delete o.loggedIn,c.del(o._host+"__"+o._instanceId+"__login_token__"),n.reject(t),o._emit("loginError",t)):(o.userId=e.id,o.loggedIn=!0,c.set(o._host+"__"+o._instanceId+"__login_token__",e.token),o._emit("login",e.id),n.resolve(e.id))}),n.promise},a.prototype.logout=function(){var t=this,e=Q.defer();return t.ddp.method("logout",[],function(o){o?(t._emit("logoutError",o),e.reject(o)):(delete t.userId,delete t.loggedIn,c.del(t._host+"__"+t._instanceId+"__login_token__"),t._emit("logout"),e.resolve())}),e.promise};var f=function(t){t&&(this._put=this.put,this._del=this.del,this.put=this.del=function(){throw new Error("Attempt to modify readonly set")}),this._items={}};f.prototype=Object.create(n.prototype),f.constructor=f,f.prototype.put=function(e,o){return u.beString(e),u.beObject(o),this._items[e]=t(o),this._emit("put",e),this},f.prototype.del=function(t){return u.beString(t),delete this._items[t],this._emit("del",t),this},f.prototype.get=function(e){return u.beString(e),t(this._items[e])},f.prototype.contains=function(t){return u.beString(t),!!this._items[t]},f.prototype.filter=function(e){var o=new f(!0),i=this._items,n=Object.keys(i);return n.forEach(function(n){var r=t(i[n]),s=e(r);s&&(o._items[n]=i[n])}),this.on("put",function(n){var r=t(i[n]),s=e(r);s&&o._put(n,i[n])}),this.on("del",function(t){o._del(t)}),o},f.prototype.toArray=function(){var e=[],o=this._items,i=Object.keys(this._items);return i.forEach(function(t){e.push(o[t])}),t(e)},f.prototype.toHash=function(){return t(this._items)},a.Set=f;var g=function(t,e,o,i){this._name=t,this._params=e,this._hash=o,this._asteroid=i,this._ready=Q.defer(),this.ready=this._ready.promise;var n=this._onReady.bind(this),r=this._onStop.bind(this),s=this._onError.bind(this);this.id=i.ddp.sub(t,e,n,r,s)};return g.constructor=g,g.prototype.stop=function(){this._asteroid.ddp.unsub(this.id),delete this._asteroid._subscriptionsCache[this._hash]},g.prototype._onReady=function(){this._ready.resolve(this.id)},g.prototype._onStop=function(){delete this._asteroid.subscriptions[this.id]},g.prototype._onError=function(t){this.ready.isPending()&&this._ready.reject(t),delete this._asteroid.subscriptions[this.id]},a.prototype.subscribe=function(t){u.beString(t);var e=Array.prototype.slice.call(arguments),o=JSON.stringify(e);if(!this._subscriptionsCache[o]){var i=e.slice(1),n=new g(t,i,o,this);this._subscriptionsCache[o]=n,this.subscriptions[n.id]=n}return this._subscriptionsCache[o]},a.prototype._reEstablishSubscriptions=function(){var t=this.subscriptions;for(var e in t)t.hasOwnProperty(e)&&(t[e]=new g(t[e]._name,t[e]._params,this))},a});