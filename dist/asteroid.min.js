!function(t,e){"function"==typeof define&&define.amd?define(e):"object"==typeof exports?module.exports=e():t.Asteroid=e()}(this,function(){"use strict";function t(t){if("undefined"!=typeof EJSON)return EJSON.clone(t);var e=typeof t;switch(e){case"undefined":case"function":return void 0;case"string":case"number":case"boolean":return t;case"object":return null===t?null:JSON.parse(JSON.stringify(t));default:return}}function e(t){var e="";for(var o in t)e+=o+"="+t[o]+"&";return e=e.slice(0,-1)}function o(){for(var t="",e=0;8>e;e++)t+=Math.floor(65536*(1+Math.random())).toString(16).substring(1);return t}function i(t,e){var o=JSON.stringify(t),i=JSON.stringify(e);return o===i}var n=function(){};n.prototype={constructor:n,_events:{},on:function(t,e){this._events[t]=this._events[t]||[],this._events[t].push(e)},off:function(t,e){this._events[t]&&this._events[t].splice(this._events[t].indexOf(e),1)},_emit:function(t){if(this._events[t]){var e=arguments,o=this;this._events[t].forEach(function(t){t.apply(o,Array.prototype.slice.call(e,1))})}}};var r=function(t){this._host=t.host,this._ddpOptions=t.ddpOptions,this._ddpOptions.do_not_autoconnect=!0,this._do_not_autocreate_collections=t._do_not_autocreate_collections,this.collections={},this.subscriptions={},this._init()};r.prototype=new n,r.prototype.constructor=r,r.prototype._init=function(){var t=this;t.ddp=new DDP(this._ddpOptions),t.ddp.on("connected",function(){t._tryResumeLogin(),t.ddp.sub("meteor.loginServiceConfiguration"),t._emit("connected")}),t.ddp.on("added",function(e){t._onAdded(e)}),t.ddp.on("changed",function(e){t._onChanged(e)}),t.ddp.on("removed",function(e){t._onRemoved(e)}),t.ddp.connect()},r.prototype._onAdded=function(t){var e=["meteor_accounts_loginServiceConfiguration","users"],o=t.collection;if(!this.collections[o]){if(this._do_not_autocreate_collections&&-1===e.indexOf(o))return;this.createCollection(o)}var i=t.fields||{};i._id=t.id,this.collections[o]._remoteToLocalInsert(i)},r.prototype._onRemoved=function(t){this.collections[t.collection]&&this.collections[t.collection]._remoteToLocalRemove(t.id)},r.prototype._onChanged=function(t){this.collections[t.collection]&&(t.fields||(t.fields={}),t.cleared&&t.cleared.forEach(function(e){t.fields[e]=void 0}),this.collections[t.collection]._remoteToLocalUpdate(t.id,t.fields))},r.prototype.subscribe=function(t){if(this.subscriptions[t])return this.subscriptions[t];var e=Q.defer();this.subscriptions[t]=e.promise;var o=Array.prototype.slice.call(arguments,1);return this.ddp.sub(t,o,function(t,o){t?e.reject(t,o):e.resolve(o)}),this.subscriptions[t]},r.prototype.unsubscribe=function(t){this.ddp.unsub(t)},r.prototype.call=function(t){var e=Array.prototype.slice.call(arguments,1);return this.apply(t,e)},r.prototype.apply=function(t,e){var o=Q.defer(),i=Q.defer(),n=function(t,e){t?(o.reject(t),i.reject()):o.resolve(e)},r=function(){i.resolve()};return this.ddp.method(t,e,n,r),{result:o.promise,updated:i.promise}},r.prototype.createCollection=function(t){return this.collections[t]||(this.collections[t]=new l(t,this,u)),this.collections[t]};var s="__del__",c="__upd__",d=function(t){var e=s.length,o=c.length,i=t.slice(-1*e),n=t.slice(-1*o);return i===s||n===c},l=function(t,e,o){this.name=t,this.asteroid=e,this.db=new o};l.prototype=new n,l.prototype.constructor=l,l.prototype._localToLocalInsert=function(t){var e=this.db.get(t._id);if(e)throw new Error("Item exists");this.db.set(t._id,t),this._emit("insert",t._id)},l.prototype._remoteToLocalInsert=function(t){var e=this.db.get(t._id);i(e,t)||(this.db.set(t._id,t),this._emit("insert",t._id))},l.prototype._restoreInserted=function(t){this.db.del(t),this._emit("restore",t)},l.prototype._localToRemoteInsert=function(t){var e=this,o=Q.defer(),i="/"+e.name+"/insert";return this.asteroid.ddp.method(i,[t],function(i,n){i?(e._restoreInserted(t._id),o.reject(i)):o.resolve(n)}),o.promise},l.prototype.insert=function(t){return t._id||(t._id=o()),this._localToLocalInsert(t,!1),this._localToRemoteInsert(t)},l.prototype._localToLocalRemove=function(t){var e=this.db.get(t);return e?(this.db.set(t+s,e),this.db.del(t),void this._emit("remove",t)):void console.warn("Item not present.")},l.prototype._remoteToLocalRemove=function(t){var e=this.db.get(t);e||(e=this.db.get(t+s),e?this.db.del(t+s):console.warn("Item not present.")),this.db.del(t),this.db.del(t+s),this._emit("remove",t)},l.prototype._restoreRemoved=function(t){var e=this.db.get(t+s);this.db.set(t,e),this.db.del(t+s),this._emit("restore",t)},l.prototype._localToRemoteRemove=function(t){var e=this,o=Q.defer(),i="/"+e.name+"/remove";return this.asteroid.ddp.method(i,[{_id:t}],function(i,n){i?(e._restoreRemoved(t),o.reject(i)):o.resolve(n)}),o.promise},l.prototype.remove=function(t){return this._localToLocalRemove(t),this._localToRemoteRemove(t)},l.prototype._localToLocalUpdate=function(t,e){var o=this.db.get(t);if(!o)throw new Error("Item not present");this.db.set(t+c,o),this.db.set(t,e),this._emit("update",t)},l.prototype._remoteToLocalUpdate=function(t,e){var o=this.db.get(t);if(!o)return void console.warn("Item not present");for(var i in e)o[i]=e[i];this.db.set(t,o),this.db.del(t+c),this._emit("update",t)},l.prototype._restoreUpdated=function(t){var e=this.db.get(t+c);this.db.set(t,e),this.db.del(t+c),this._emit("restore",t)},l.prototype._localToRemoteUpdate=function(t,e){var o=this,i=Q.defer(),n="/"+o.name+"/update",r={_id:t},s={$set:e};return this.asteroid.ddp.method(n,[r,s],function(e,n){e?(o._restoreUpdated(t),i.reject(e)):i.resolve(n)}),i.promise},l.prototype.update=function(t,e){return this._localToLocalUpdate(t,e),this._localToRemoteUpdate(t,e)},l.prototype.find=function(t){return this.db.find(t)},l.prototype.findOne=function(t){return this.db.findOne(t)};var u=function(){this.itemsHash={},this.itemsArray=[]};return u.prototype.constructor=u,u.prototype.set=function(e,o){if(o=t(o),this.itemsHash[e]){var i=this.itemsArray.indexOf(this.itemsHash[e]);this.itemsArray[i]=o}else this.itemsArray.push(o);this.itemsHash[e]=o},u.prototype.get=function(e){return t(this.itemsHash[e])},u.prototype.find=function(e){var o=function(t,e){return e.split(".").reduce(function(t,e){return t=t[e]},t)},i=Object.keys(e),n=[];return this.itemsArray.forEach(function(r){for(var s=0;s<i.length;s++){var c=o(r,i[s]);if(c!==e[i[s]])return}d(r._id)||n.push(t(r))}),n},u.prototype.findOne=function(t){return this.find(t)[0]},u.prototype.del=function(t){if(this.itemsHash[t]){var e=this.itemsArray.indexOf(this.itemsHash[t]);this.itemsArray.splice(e,1),delete this.itemsHash[t]}},u.prototype.ls=function(){return t(this.itemsArray)},r.DumbDb=u,r.prototype._getOauthClientId=function(t){var e="meteor_accounts_loginServiceConfiguration",o=this.collections[e].db.itemsArray,i="";return o.forEach(function(e){e.service===t&&("facebook"===t&&(i=e.appId),"google"===t&&(i=e.clientId),"github"===t&&(i=e.clientId),"twitter"===t&&(i=e.consumerKey))}),i},r.prototype._initOauthLogin=function(t,e,o){var i=this;return Q().then(function(){var t=Q.defer(),e=window.open(o,"Login");e.focus&&e.focus();var i=setInterval(function(){(e.closed||void 0===e.closed)&&(clearInterval(i),t.resolve())},100);return t.promise}).then(function(){var t=Q.defer(),o={oauth:{credentialToken:e}};return i.ddp.method("login",[o],function(e,o){e?(delete i.userId,delete i.loggedIn,delete localStorage[i._host+"__login_token__"],t.reject(e),i._emit("loginError",e)):(i.userId=o.id,i.loggedIn=!0,localStorage[i._host+"__login_token__"]=o.token,i._emit("login",o),t.resolve(o.id))}),t.promise})},r.prototype._tryResumeLogin=function(){var t=this,e=localStorage[t._host+"__login_token__"];return e?Q().then(function(){var o=Q.defer(),i={resume:e};return t.ddp.method("login",[i],function(e,i){e?(delete t.userId,delete t.loggedIn,delete localStorage[t._host+"__login_token__"],t._emit("loginError",e),o.reject(e)):(t.userId=i.id,t.loggedIn=!0,localStorage[t._host+"__login_token__"]=i.token,t._emit("login",i),o.resolve(i.id))}),o.promise}):void 0},r.prototype.loginWithFacebook=function(t){var i=o(),n={client_id:this._getOauthClientId("facebook"),redirect_uri:this._host+"/_oauth/facebook?close",state:i,scope:t||"email"},r="https://www.facebook.com/dialog/oauth?"+e(n);return this._initOauthLogin("facebook",i,r)},r.prototype.loginWithGoogle=function(t){var i=o(),n={response_type:"code",client_id:this._getOauthClientId("google"),redirect_uri:this._host+"/_oauth/google?close",state:i,scope:t||"openid email"},r="https://accounts.google.com/o/oauth2/auth?"+e(n);return this._initOauthLogin("google",i,r)},r.prototype.loginWithGithub=function(t){var i=o(),n={client_id:this._getOauthClientId("github"),redirect_uri:this._host+"/_oauth/github?close",state:i,scope:t||"email"},r="https://github.com/login/oauth/authorize?"+e(n);return this._initOauthLogin("github",i,r)},r.prototype.loginWithTwitter=function(){var t=o(),i=this._host+"/_oauth/twitter?close&state="+t,n={requestTokenAndRedirect:encodeURIComponent(i),state:t},r=this._host+"/_oauth/twitter/?"+e(n);return this._initOauthLogin("twitter",t,r)},r.prototype.logout=function(){var t=this,e=Q.defer();return t.ddp.method("logout",[],function(o,i){o?(t._emit("logoutError",o),e.reject(o)):(delete t.userId,delete t.loggedIn,delete localStorage[t._host+"__login_token__"],t._emit("logout",i),e.resolve(i))}),e.promise},r});